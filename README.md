# polygon-triangulator-debug

See documentation on the github pages at https://craigtaverner.github.io/polygon-triangulator-debug/

Visual approach to debugging the polygon triangulation algorithm in the Apache Lucene `Tessellator` class.
It implements the `Tessellator.Monitor` interface to receive events during the triangulation algorithm,
and uses these events to generate PNG images of the incoming polygon together with the current status
of the internal linked-list of nodes and set of completed triangles generated so far.

The images can be stitched together into a video using tools like `ffmpeg`:

    ffmpeg -r 5 -i /tmp/tessellation/polygon-1/polygon-1-%%05d.png -c:v libx264 -vf fps=25 -pix_fmt yuv420p polygon-1.mp4

There are two ways to run the monitor:

* Within tests, for example within existing `TestTessellator` tests in Lucene
* On the command-line using the provided command-line app

## Tests

Consider a test within Lucene, for example:

    @Test
    public void testComplexPolygon48() throws Exception {
        String geoJson = PolygonUtils.readShape("lucene-10470-3.geojson.gz");
        Polygon[] polygons = Polygon.fromGeoJSON(geoJson);
        for (Polygon polygon : polygons) {
            List<Tessellator.Triangle> tessellation = Tessellator.tessellate(polygon, true);
            // calculate the area of big polygons have numerical error
            assertEquals(area(polygon), area(tessellation), 1e-11);
            for (TessellatorX.Triangle t : tessellation) {
                checkTriangleEdgesFromPolygon(polygon, t);
            }
        }
    }

It is as simple as adding an extra argument to the `Tessellator.tesselate()` call:

    Tessellator.tessellate(polygon, true, new TriangulationMonitor("lucene-10470-3", polygon, imageConfig));

Where the `imageConfig` defines the size of images to generate:

    TriangulationMonitor.Config imageConfig = new TriangulationMonitor.Config(Path.of("/tmp/tessellation"), 1500, 1000, 100);

If the polygons are not too large, it is particularly useful to show labels of the vertices of the polygons and the
internal linked-list using:

    imageConfig.withLabels();

A complete test that includes this could look like:

    @Test
    public void testComplexPolygon48() throws Exception {
        TriangulationMonitor.Config imageConfig = new TriangulationMonitor.Config(Path.of("/tmp/tessellation"), 1500, 1000, 100).withLabels();
        String geoJson = PolygonUtils.readShape("lucene-10563-3.geojson.gz");
        Polygon[] polygons = Polygon.fromGeoJSON(geoJson);
        for (Polygon polygon : polygons) {
            List<TessellatorX.Triangle> tessellation = TessellatorX.tessellate(polygon, true, new TriangulationMonitor("lucene-10563-3", polygon, imageConfig));
            // calculate the area of big polygons have numerical error
            assertEquals(area(polygon), area(tessellation), 1e-11);
            for (TessellatorX.Triangle t : tessellation) {
                checkTriangleEdgesFromPolygon(polygon, t);
            }
        }
    }

Note in the two examples above we used different polygons:

* `lucene-10470-3` is a very large polygon and is best rendered without labels
* `lucene-10563-1` is much smaller and can be rendered in detail with labels

### Generating images and video

The image configuration above also specified the path to a directory to use.
For example, if we use the following:

    TriangulationMonitor.Config imageConfig = new TriangulationMonitor.Config(Path.of("/tmp/tessellation"), 1500, 1000, 100);
    Tessellator.tessellate(polygon, true, new TriangulationMonitor("lucene-10563-3", polygon, imageConfig.withLabels()));

We will create a directory at `/tmp/tessellation/lucene-10563-3/` which will contain over 400 files with names
like `lucene-10563-3-00043.png`.
The counter starts at `0` and will increment for each image.
This allows us to generate a video by combining the images with a tool like `ffmpeg`:

    ffmpeg -r 5 -i /tmp/tessellation/lucene-10563-3/lucene-10563-3-%%05d.png -c:v libx264 -vf fps=25 -pix_fmt yuv420p lucene-10563-3.mp4

For relatively small polygons like `lucene-10563-1` a framerate of `5` works well to watch the progress of the triangulation.
For much larger polygons like `lucene-10470-3` there are over 23 thousand images, and you should increase the framerate a lot:

    ffmpeg -r 100 -i /tmp/tessellation/lucene-10470-3/lucene-10470-3-%05d.png -c:v libx264 -vf fps=25 -pix_fmt yuv420p lucene-10470-3.mp4

## Command-line

The images generated by tests above can also be generated using a command-line tool, provided by the main method in
the class `org.amanzi.lucene.geo.App`:

    usage: lucene-triangulator-debug <--options> name1 <name2...>
    options:
        -h | --help       Output this help
        -v | --verbose    Verbose output: %b
        -l | --labels     Add labels to images: %b
        -D | --dir        Set the output directory for image files: '%s'
        -W | --width      Set the image width: %d
        -H | --height     Set the image height: %d
        -M | --margin     Set the image margin: %d

    The names should either be paths to files, like src/main/resources/org/apache/lucene/geo/lucene-10563-1.geojson.gz
    or the names (without path and extension) of files in the same package and classpath as the PolygonUtils
    class, for example lucene-10563-1 exists in package org.apache.lucene.geo.
    The tool will take each name and look for files called name.geojson.gz, import those as
    GeoJSON polygons, and run the triangulation algorithm on the first polygon.
    During triangulation, it will output as many images as there are steps in the triangulation
    to the directory '%s' with filenames prefixed by the original name, and suffixed with an
    incrementing counter, allowing a tool like 'ffmpeg' to be used to generate a video.
            
    For example, with a name like 'polygon-1' we will have files named 'polygon-1-0001.png' and can
    generate a video with a command like:
        ffmpeg -r 5 -i /tmp/tessellation/polygon-1/polygon-1-%%05d.png -c:v libx264 -vf fps=25 -pix_fmt yuv420p polygon-1.mp4


For example the following command:

    ./lucene-triangulator-debug -D docs/images -l -W 1000 -H 600 -M 50 app/src/main/resources/org/apache/lucene/geo/lucene-10563-1.geojson.gz

Would make images starting with:

![Lucene-10563-1 Polygon](docs/images/lucene-10563-1/lucene-10563-1-00000.png?raw=true "Lucene-10563-1 Polygon")

About half way through the triangulation algorithm, we would see:

![Lucene-10563-1 Polygon](docs/images/lucene-10563-1/lucene-10563-1-00200.png?raw=true "Lucene-10563-1 Polygon")
